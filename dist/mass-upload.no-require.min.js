/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(){var t,n,o;!function(r){function e(t,n){return y.call(t,n)}function i(t,n){var o,r,e,i,s,l,u,a,c,f,d=n&&n.split("/"),p=S.map,h=p&&p["*"]||{};if(t&&"."===t.charAt(0))if(n){for(d=d.slice(0,d.length-1),t=d.concat(t.split("/")),a=0;a<t.length;a+=1)if(f=t[a],"."===f)t.splice(a,1),a-=1;else if(".."===f){if(1===a&&(".."===t[2]||".."===t[0]))break;a>0&&(t.splice(a-1,2),a-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((d||h)&&p){for(o=t.split("/"),a=o.length;a>0;a-=1){if(r=o.slice(0,a).join("/"),d)for(c=d.length;c>0;c-=1)if(e=p[d.slice(0,c).join("/")],e&&(e=e[r])){i=e,s=a;break}if(i)break;!l&&h&&h[r]&&(l=h[r],u=a)}!i&&l&&(i=l,s=u),i&&(o.splice(0,s,i),t=o.join("/"))}return t}function s(t,n){return function(){return p.apply(r,U.call(arguments,0).concat([t,n]))}}function l(t){return function(n){return i(n,t)}}function u(t){return function(n){_[t]=n}}function a(t){if(e(v,t)){var n=v[t];delete v[t],b[t]=!0,d.apply(r,n)}if(!e(_,t)&&!e(b,t))throw new Error("No "+t);return _[t]}function c(t){var n,o=t?t.indexOf("!"):-1;return o>-1&&(n=t.substring(0,o),t=t.substring(o+1,t.length)),[n,t]}function f(t){return function(){return S&&S.config&&S.config[t]||{}}}var d,p,h,g,_={},v={},S={},b={},y=Object.prototype.hasOwnProperty,U=[].slice;h=function(t,n){var o,r=c(t),e=r[0];return t=r[1],e&&(e=i(e,n),o=a(e)),e?t=o&&o.normalize?o.normalize(t,l(n)):i(t,n):(t=i(t,n),r=c(t),e=r[0],t=r[1],e&&(o=a(e))),{f:e?e+"!"+t:t,n:t,pr:e,p:o}},g={require:function(t){return s(t)},exports:function(t){var n=_[t];return"undefined"!=typeof n?n:_[t]={}},module:function(t){return{id:t,uri:"",exports:_[t],config:f(t)}}},d=function(t,n,o,i){var l,c,f,d,p,S,y=[];if(i=i||t,"function"==typeof o){for(n=!n.length&&o.length?["require","exports","module"]:n,p=0;p<n.length;p+=1)if(d=h(n[p],i),c=d.f,"require"===c)y[p]=g.require(t);else if("exports"===c)y[p]=g.exports(t),S=!0;else if("module"===c)l=y[p]=g.module(t);else if(e(_,c)||e(v,c)||e(b,c))y[p]=a(c);else{if(!d.p)throw new Error(t+" missing "+c);d.p.load(d.n,s(i,!0),u(c),{}),y[p]=_[c]}f=o.apply(_[t],y),t&&(l&&l.exports!==r&&l.exports!==_[t]?_[t]=l.exports:f===r&&S||(_[t]=f))}else t&&(_[t]=o)},t=n=p=function(t,n,o,e,i){return"string"==typeof t?g[t]?g[t](n):a(h(t,n).f):(t.splice||(S=t,n.splice?(t=n,n=o,o=null):t=r),n=n||function(){},"function"==typeof o&&(o=e,e=i),e?d(r,t,n,o):setTimeout(function(){d(r,t,n,o)},4),p)},p.config=function(t){return S=t,S.deps&&p(S.deps,S.callback),p},o=function(t,n,o){n.splice||(o=n,n=[]),e(_,t)||e(v,t)||(v[t]=[t,n,o])},o.amd={jQuery:!0}}(),o("almond",function(){}),o("MassUpload/FileInfo",[],function(){var t;return t=function(){function t(t,n,o,r){this.name=t,this.lastModifiedDate=n,this.total=o,this.loaded=r}return t}(),t.fromJson=function(n){return new t(n.name,new Date(n.lastModifiedDate),n.total,n.loaded)},t.fromFile=function(n){return new t(n.name,n.lastModifiedDate,n.size,0)},t}),o("MassUpload/Upload",["backbone","./FileInfo"],function(t,n){return t.Model.extend({defaults:{file:null,fileInfo:null,error:null,uploading:!1,deleting:!1},initialize:function(t){var n,o,r;return n=null!=(r=t.file)?r:t.fileInfo,o=n.name,this.set({id:o})},updateWithProgress:function(t){var o;return o=n.fromFile(this.get("file")),o.loaded=t.loaded,o.total=t.total,this.set("fileInfo",o)},isFullyUploaded:function(){var t,n;return n=this.get("fileInfo"),t=this.get("error"),!this.get("uploading")&&!this.get("deleting")&&null==this.get("error")&&null!=n&&n.loaded===n.total},hasConflict:function(){var t,n;return n=this.get("fileInfo"),t=this.get("file"),null!=n&&null!=t&&(n.name!==t.name||n.lastModifiedDate.getTime()!==t.lastModifiedDate.getTime()||n.total!==t.size)}})}),o("MassUpload/UploadCollection",["backbone","./Upload"],function(t,n){return t.Collection.extend({model:n,comparator:"id",addFiles:function(t){var o,r;return r=function(){var r,e,i;for(i=[],r=0,e=t.length;e>r;r++)o=t[r],i.push(new n({file:o}));return i}(),this._addWithMerge(r)},addFileInfos:function(t){var o,r;return r=function(){var r,e,i;for(i=[],r=0,e=t.length;e>r;r++)o=t[r],i.push(new n({fileInfo:o}));return i}(),this._addWithMerge(r)},next:function(){var t,n,o,r;return t=null,r=null,n=null,o=null,this.each(function(e){var i,s;return i=e.get("file"),s=e.get("fileInfo"),null==e.get("error")&&(e.get("deleting")&&(t||(t=e)),e.get("uploading")&&(r||(r=e)),i&&s&&s.loaded<s.total&&(n||(n=e)),i&&!s)?o||(o=e):void 0}),t||r||n||o},_addWithMerge:function(t){var n,o,r,e,i,s,l;for(e=[],s=0,l=t.length;l>s;s++)i=t[s],null!=(n=this.get(i.id))?(o=i.get("file"),r=i.get("fileInfo"),null!=o&&n.set({file:o}),null!=r&&n.set({fileInfo:r})):e.push(i);return this.add(e)}})}),o("MassUpload/FileLister",[],function(){var t;return t=function(){function t(t,n){this.doListFiles=t,this.callbacks=n,this.running=!1}return t.prototype.run=function(){var t,n=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(t=this.callbacks).onStart&&t.onStart(),this.doListFiles(function(t){var o;return"function"==typeof(o=n.callbacks).onProgress?o.onProgress(t):void 0},function(t){return n._onSuccess(t)},function(t){return n._onError(t)})},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop()},t.prototype._onError=function(t){return this.callbacks.onError(t),this._onStop()},t.prototype._onStop=function(){var t;return this.running=!1,"function"==typeof(t=this.callbacks).onStop?t.onStop():void 0},t}()}),o("MassUpload/FileUploader",["./FileInfo"],function(){var t;return t=function(){function t(t,n){this.doUpload=t,this.callbacks=n,this._file=null,this._abortCallback=null,this._aborting=!1}return t.prototype.run=function(t){var n,o=this;if(null!=this._file)throw"already running";return this._file=t,"function"==typeof(n=this.callbacks).onStart&&n.onStart(this._file),this._abortCallback=this.doUpload(t,function(n){return o._onProgress(t,n)},function(){return o._onSuccess(t)},function(n){return o._onError(t,n)})},t.prototype.abort=function(){return this._file&&!this._aborting&&(this._aborting=!0,"function"==typeof this._abortCallback)?this._abortCallback():void 0},t.prototype._onProgress=function(t,n){var o;return"function"==typeof(o=this.callbacks).onProgress?o.onProgress(t,n):void 0},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,n){var o;return"function"==typeof(o=this.callbacks).onError&&o.onError(t,n),this._onStop(t)},t.prototype._onStop=function(t){var n;return this._file=null,this._abortCallback=null,this._aborting=!1,"function"==typeof(n=this.callbacks).onStop?n.onStop(t):void 0},t}()}),o("MassUpload/FileDeleter",[],function(){var t;return t=function(){function t(t,n){this.doDeleteFile=t,this.callbacks=null!=n?n:{},this.running=!1}return t.prototype.run=function(t){var n,o=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(n=this.callbacks).onStart&&n.onStart(t),this.doDeleteFile(t,function(){return o._onSuccess(t)},function(n){return o._onError(t,n)})},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,n){var o;return"function"==typeof(o=this.callbacks).onError&&o.onError(t,n),this._onStop(t)},t.prototype._onStop=function(t){var n;return this.running=!1,"function"==typeof(n=this.callbacks).onStop&&n.onStop(t),void 0},t}()}),o("MassUpload/State",[],function(){var t;return t=function(){function t(t){var n,o,r,e;null==t&&(t={}),this.loaded=null!=(n=t.loaded)?n:0,this.total=null!=(o=t.total)?o:0,this.status=null!=(r=t.status)?r:"waiting",this.errors=null!=(e=t.errors)?e:[]}return t.prototype._extend=function(n){var o,r,e,i;return new t({loaded:null!=(o=n.loaded)?o:this.loaded,total:null!=(r=n.total)?r:this.total,status:null!=(e=n.status)?e:this.status,errors:null!=(i=n.errors)?i:this.errors})},t.prototype.isComplete=function(){return this.total&&this.loaded===this.total&&"waiting"===this.status&&!this.errors.length&&!0||!1},t.prototype.withTotal=function(t){return this._extend({total:t})},t.prototype.withLoaded=function(t){return this._extend({loaded:t})},t.prototype.withStatus=function(t){return this._extend({status:t})},t.prototype.withAnError=function(t){var n;return n=this.errors.slice(0),n.push(t),this._extend({errors:n})},t.prototype.withoutAnError=function(t){var n,o;return o=this.errors.slice(0),n=o.indexOf(t),o.splice(n,1),this._extend({errors:o})},t}()}),o("MassUpload",["backbone","./MassUpload/UploadCollection","./MassUpload/FileLister","./MassUpload/FileUploader","./MassUpload/FileDeleter","./MassUpload/State"],function(t,n,o,r,e){return t.Model.extend({defaults:function(){return{status:"waiting",listFilesProgress:null,listFilesError:null,uploadProgress:null,uploadErrors:[]}},constructor:function(n){return this._removedUploads=[],t.Model.call(this,{},n)},initialize:function(t,i){var s,l,u,a,c=this;return this.uploads=null!=(s=null!=i?i.uploads:void 0)?s:new n,this.lister=null!=(l=null!=i?i.lister:void 0)?l:new o(i.doListFiles),this.lister.callbacks={onStart:function(){return c._onListerStart()},onProgress:function(t){return c._onListerProgress(t)},onSuccess:function(t){return c._onListerSuccess(t)},onError:function(t){return c._onListerError(t)},onStop:function(){return c._onListerStop()}},this.uploader=null!=(u=null!=i?i.uploader:void 0)?u:new r(i.doUploadFile),this.uploader.callbacks={onStart:function(t){return c._onUploaderStart(t)},onStop:function(t){return c._onUploaderStop(t)},onSuccess:function(t){return c._onUploaderSuccess(t)},onError:function(t,n){return c._onUploaderError(t,n)},onProgress:function(t,n){return c._onUploaderProgress(t,n)}},this.deleter=null!=(a=null!=i?i.deleter:void 0)?a:new e(i.doDeleteFile),this.deleter.callbacks={onStart:function(t){return c._onDeleterStart(t)},onSuccess:function(t){return c._onDeleterSuccess(t)},onError:function(t,n){return c._onDeleterError(t,n)},onStop:function(t){return c._onDeleterStop(t)}},this.uploads.on("add change:file",function(t){return c._onUploadAdded(t)}),this.uploads.on("change:deleting",function(t){return c._onUploadDeleted(t)}),this.uploads.on("remove",function(t){return c._onUploadRemoved(t)})},fetchFileInfosFromServer:function(){return this.lister.run()},retryListFiles:function(){return this.fetchFileInfosFromServer()},addFiles:function(t){return this.uploads.addFiles(t)},removeUpload:function(t){return t.set("deleting",!0)},_onListerStart:function(){return this.set("status","listing-files"),this.set("listFilesError",null)},_onListerProgress:function(t){return this.set("listFilesProgress",t)},_onListerSuccess:function(t){return this.uploads.addFileInfos(t),this._tick()},_onListerError:function(t){return this.set("listFilesError",t),this.set("status","listing-files-error")},_onListerStop:function(){},_onUploadAdded:function(){var t;return t=this.get("status"),"uploading"===t||"uploading-error"===t?this.uploader.abort():this._tick()},_onUploadRemoved:function(t){return this.uploads.remove(t)},_onUploadDeleted:function(t){var n;return this._removedUploads.push(t),n=this.get("status"),"uploading"===n||"uploading-error"===n?this.uploader.abort():this._tick()},_onUploaderStart:function(t){var n;return this.set("status","uploading"),n=this.uploads.get(t.name),n.set({uploading:!0,error:null})},_onUploaderStop:function(t){var n;return n=this.uploads.get(t.name),n.set("uploading",!1),this._tick()},_onUploaderProgress:function(t,n){var o;return o=this.uploads.get(t.name),o.updateWithProgress(n)},_onUploaderError:function(t,n){var o;return o=this.uploads.get(t.name),o.set("error",n)},_onUploaderSuccess:function(){},_onDeleterStart:function(){return this.set("status","uploading")},_onDeleterSuccess:function(t){return this.uploads.remove(t)},_onDeleterError:function(t,n){var o;return o=this.uploads.get(t.name),o.set("error",n)},_onDeleterStop:function(){return this._tick()},_tick:function(){var t;return t=this.uploads.next(),null!=t?t.get("deleting")?this.deleter.run(t.get("fileInfo")):this.uploader.run(t.get("file")):this.set("status","waiting")}})}),n(["./MassUpload"],function(t){return window.MassUpload=t}),o("index",function(){})}();