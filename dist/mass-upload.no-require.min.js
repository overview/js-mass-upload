/**
 * @license almond 0.2.9 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(){var t,n,r;!function(e){function o(t,n){return b.call(t,n)}function i(t,n){var r,e,o,i,s,l,u,a,c,d,p,f=n&&n.split("/"),h=y.map,g=h&&h["*"]||{};if(t&&"."===t.charAt(0))if(n){for(f=f.slice(0,f.length-1),t=t.split("/"),s=t.length-1,y.nodeIdCompat&&m.test(t[s])&&(t[s]=t[s].replace(m,"")),t=f.concat(t),c=0;c<t.length;c+=1)if(p=t[c],"."===p)t.splice(c,1),c-=1;else if(".."===p){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((f||g)&&h){for(r=t.split("/"),c=r.length;c>0;c-=1){if(e=r.slice(0,c).join("/"),f)for(d=f.length;d>0;d-=1)if(o=h[f.slice(0,d).join("/")],o&&(o=o[e])){i=o,l=c;break}if(i)break;!u&&g&&g[e]&&(u=g[e],a=c)}!i&&u&&(i=u,l=a),i&&(r.splice(0,l,i),t=r.join("/"))}return t}function s(t,n){return function(){return f.apply(e,U.call(arguments,0).concat([t,n]))}}function l(t){return function(n){return i(n,t)}}function u(t){return function(n){_[t]=n}}function a(t){if(o(v,t)){var n=v[t];delete v[t],S[t]=!0,p.apply(e,n)}if(!o(_,t)&&!o(S,t))throw new Error("No "+t);return _[t]}function c(t){var n,r=t?t.indexOf("!"):-1;return r>-1&&(n=t.substring(0,r),t=t.substring(r+1,t.length)),[n,t]}function d(t){return function(){return y&&y.config&&y.config[t]||{}}}var p,f,h,g,_={},v={},y={},S={},b=Object.prototype.hasOwnProperty,U=[].slice,m=/\.js$/;h=function(t,n){var r,e=c(t),o=e[0];return t=e[1],o&&(o=i(o,n),r=a(o)),o?t=r&&r.normalize?r.normalize(t,l(n)):i(t,n):(t=i(t,n),e=c(t),o=e[0],t=e[1],o&&(r=a(o))),{f:o?o+"!"+t:t,n:t,pr:o,p:r}},g={require:function(t){return s(t)},exports:function(t){var n=_[t];return"undefined"!=typeof n?n:_[t]={}},module:function(t){return{id:t,uri:"",exports:_[t],config:d(t)}}},p=function(t,n,r,i){var l,c,d,p,f,y,b=[],U=typeof r;if(i=i||t,"undefined"===U||"function"===U){for(n=!n.length&&r.length?["require","exports","module"]:n,f=0;f<n.length;f+=1)if(p=h(n[f],i),c=p.f,"require"===c)b[f]=g.require(t);else if("exports"===c)b[f]=g.exports(t),y=!0;else if("module"===c)l=b[f]=g.module(t);else if(o(_,c)||o(v,c)||o(S,c))b[f]=a(c);else{if(!p.p)throw new Error(t+" missing "+c);p.p.load(p.n,s(i,!0),u(c),{}),b[f]=_[c]}d=r?r.apply(_[t],b):void 0,t&&(l&&l.exports!==e&&l.exports!==_[t]?_[t]=l.exports:d===e&&y||(_[t]=d))}else t&&(_[t]=r)},t=n=f=function(t,n,r,o,i){if("string"==typeof t)return g[t]?g[t](n):a(h(t,n).f);if(!t.splice){if(y=t,y.deps&&f(y.deps,y.callback),!n)return;n.splice?(t=n,n=r,r=null):t=e}return n=n||function(){},"function"==typeof r&&(r=o,o=i),o?p(e,t,n,r):setTimeout(function(){p(e,t,n,r)},4),f},f.config=function(t){return f(t)},t._defined=_,r=function(t,n,r){n.splice||(r=n,n=[]),o(_,t)||o(v,t)||(v[t]=[t,n,r])},r.amd={jQuery:!0}}(),r("almond",function(){}),r("MassUpload/FileInfo",[],function(){var t;return t=function(){function t(t,n,r,e){this.name=t,this.lastModifiedDate=n,this.total=r,this.loaded=e}return t}(),t.fromJson=function(n){return new t(n.name,new Date(n.lastModifiedDate),n.total,n.loaded)},t.fromFile=function(n){return new t(n.name,n.lastModifiedDate,n.size,0)},t});var e={}.hasOwnProperty,o=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};r("MassUpload/Upload",["backbone","./FileInfo"],function(t,n){var r,e;return r=function(t){function r(){return e=r.__super__.constructor.apply(this,arguments)}return o(r,t),r.prototype.defaults={file:null,fileInfo:null,error:null,uploading:!1,deleting:!1},r.prototype.initialize=function(t){var n,r,e;return n=null!=(e=t.file)?e:t.fileInfo,r=n.name,this.set({id:r})},r.prototype.updateWithProgress=function(t){var r,e;return e=this.fstatSync(),r=new n(this.id,e.lastModifiedDate,t.total,t.loaded),this.set("fileInfo",r)},r.prototype.getProgress=function(){var t,n;return null==(n=this.get("fileInfo"))||this.hasConflict()?null!=(t=this.get("file"))?{loaded:0,total:this.fstatSync().size}:void 0:{loaded:n.loaded,total:n.total}},r.prototype.fstatSync=function(){var t;return t=this.get("file"),null!=t?null!=this._fstat?this._fstat:this._fstat={size:t.size,lastModifiedDate:t.lastModifiedDate}:void 0},r.prototype.isFullyUploaded=function(){var t,n;return n=this.get("fileInfo"),t=this.get("error"),!this.get("uploading")&&!this.get("deleting")&&null==this.get("error")&&null!=n&&n.loaded===n.total},r.prototype.hasConflict=function(){var t,n;return n=this.get("fileInfo"),t=this.get("file"),null!=n&&null!=t&&(n.name!==t.name||n.lastModifiedDate.getTime()!==this.fstatSync().lastModifiedDate.getTime()||n.total!==this.fstatSync().size)},r}(t.Model)});var e={}.hasOwnProperty,o=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};r("MassUpload/UploadCollection",["backbone","./Upload"],function(t,n){var r,e,i;return e=function(){function t(){this._clear()}return t.prototype._clear=function(){return this.deleting=[],this.uploading=[],this.unfinished=[],this.unstarted=[]},t.prototype.uploadAttributesToState=function(t){var n;return n=null!=t.error?null:t.deleting?"deleting":t.uploading?"uploading":null!=t.file&&null!=t.fileInfo&&t.fileInfo.loaded<t.fileInfo.total?"unfinished":null!=t.file&&null==t.fileInfo?"unstarted":null},t.prototype.addBatch=function(t){var n,r,e,o,i;for(i=[],e=0,o=t.length;o>e;e++)r=t[e],n=this.uploadAttributesToState(r.attributes),null!=n?i.push(this[n].push(r)):i.push(void 0);return i},t.prototype._removeUploadFromArray=function(t,n){var r;return r=n.indexOf(t),r>=0?n.splice(r,1):void 0},t.prototype.remove=function(t){var n;return n=this.uploadAttributesToState(t.attributes),null!=n?this._removeUploadFromArray(t.attributes,this[n]):void 0},t.prototype.change=function(t){var n,r;return r=this.uploadAttributesToState(t.previousAttributes()),n=this.uploadAttributesToState(t.attributes),r!==n&&(null!=r&&this._removeUploadFromArray(t,this[r]),null!=n)?this[n].push(t):void 0},t.prototype.reset=function(t){return this._clear(),this.addBatch(t.models)},t.prototype.next=function(){var t,n,r,e;return null!=(t=null!=(n=null!=(r=null!=(e=this.deleting[0])?e:this.uploading[0])?r:this.unfinished[0])?n:this.unstarted[0])?t:null},t}(),r=function(t){function r(){return i=r.__super__.constructor.apply(this,arguments)}return o(r,t),r.prototype.model=n,r.prototype.initialize=function(){var t,n,r,o;for(this._priorityQueue=new e,this.on("add-batch",this._priorityQueue.addBatch,this._priorityQueue),o=["change","remove","reset"],n=0,r=o.length;r>n;n++)t=o[n],this.on(t,this._priorityQueue[t],this._priorityQueue);return this._priorityQueue.reset(this)},r.prototype.addFiles=function(t){var r,e;return e=function(){var e,o,i;for(i=[],e=0,o=t.length;o>e;e++)r=t[e],i.push(new n({file:r}));return i}(),this._addWithMerge(e)},r.prototype.addFileInfos=function(t){var r,e;return e=function(){var e,o,i;for(i=[],e=0,o=t.length;o>e;e++)r=t[e],i.push(new n({fileInfo:r}));return i}(),this._addWithMerge(e)},r.prototype.next=function(){return this._priorityQueue.next()},r.prototype._addWithMerge=function(t){var n,r,e,o,i,s,l;for(o=[],s=0,l=t.length;l>s;s++)i=t[s],null!=(n=this.get(i.id))?(r=i.get("file"),e=i.get("fileInfo"),null!=r&&n.set({file:r}),null!=e&&n.set({fileInfo:e})):o.push(i);return o.length?(this.add(o),this.trigger("add-batch",o)):void 0},r}(t.Collection)}),r("MassUpload/FileLister",[],function(){var t;return t=function(){function t(t,n){this.doListFiles=t,this.callbacks=n,this.running=!1}return t.prototype.run=function(){var t,n=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(t=this.callbacks).onStart&&t.onStart(),this.doListFiles(function(t){var r;return"function"==typeof(r=n.callbacks).onProgress?r.onProgress(t):void 0},function(t){return n._onSuccess(t)},function(t){return n._onError(t)})},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop()},t.prototype._onError=function(t){return this.callbacks.onError(t),this._onStop()},t.prototype._onStop=function(){var t;return this.running=!1,"function"==typeof(t=this.callbacks).onStop?t.onStop():void 0},t}()}),r("MassUpload/FileUploader",["./FileInfo"],function(){var t;return t=function(){function t(t,n){this.doUpload=t,this.callbacks=n,this._file=null,this._abortCallback=null,this._aborting=!1}return t.prototype.run=function(t){var n,r=this;if(null!=this._file)throw"already running";return this._file=t,"function"==typeof(n=this.callbacks).onStart&&n.onStart(this._file),this._abortCallback=this.doUpload(t,function(n){return r._onProgress(t,n)},function(){return r._onSuccess(t)},function(n){return r._onError(t,n)})},t.prototype.abort=function(){return this._file&&!this._aborting&&(this._aborting=!0,"function"==typeof this._abortCallback)?this._abortCallback():void 0},t.prototype._onProgress=function(t,n){var r;return"function"==typeof(r=this.callbacks).onProgress?r.onProgress(t,n):void 0},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,n){var r;return"function"==typeof(r=this.callbacks).onError&&r.onError(t,n),this._onStop(t)},t.prototype._onStop=function(t){var n;return this._file=null,this._abortCallback=null,this._aborting=!1,"function"==typeof(n=this.callbacks).onStop?n.onStop(t):void 0},t}()}),r("MassUpload/FileDeleter",[],function(){var t;return t=function(){function t(t,n){this.doDeleteFile=t,this.callbacks=null!=n?n:{},this.running=!1}return t.prototype.run=function(t){var n,r=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(n=this.callbacks).onStart&&n.onStart(t),this.doDeleteFile(t,function(){return r._onSuccess(t)},function(n){return r._onError(t,n)})},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,n){var r;return"function"==typeof(r=this.callbacks).onError&&r.onError(t,n),this._onStop(t)},t.prototype._onStop=function(t){var n;return this.running=!1,"function"==typeof(n=this.callbacks).onStop&&n.onStop(t),void 0},t}()}),r("MassUpload/State",[],function(){var t;return t=function(){function t(t){var n,r,e,o;null==t&&(t={}),this.loaded=null!=(n=t.loaded)?n:0,this.total=null!=(r=t.total)?r:0,this.status=null!=(e=t.status)?e:"waiting",this.errors=null!=(o=t.errors)?o:[]}return t.prototype._extend=function(n){var r,e,o,i;return new t({loaded:null!=(r=n.loaded)?r:this.loaded,total:null!=(e=n.total)?e:this.total,status:null!=(o=n.status)?o:this.status,errors:null!=(i=n.errors)?i:this.errors})},t.prototype.isComplete=function(){return this.total&&this.loaded===this.total&&"waiting"===this.status&&!this.errors.length&&!0||!1},t.prototype.withTotal=function(t){return this._extend({total:t})},t.prototype.withLoaded=function(t){return this._extend({loaded:t})},t.prototype.withStatus=function(t){return this._extend({status:t})},t.prototype.withAnError=function(t){var n;return n=this.errors.slice(0),n.push(t),this._extend({errors:n})},t.prototype.withoutAnError=function(t){var n,r;return r=this.errors.slice(0),n=r.indexOf(t),r.splice(n,1),this._extend({errors:r})},t}()}),r("MassUpload/UploadProgress",["backbone"],function(t){return t.Model.extend({defaults:{loaded:0,total:0},initialize:function(){var t;if(t=this.get("collection"),null==t)throw"Must initialize UploadProgress with `collection`, an UploadCollection";return this._updateAndStartListening()},_updateAndStartListening:function(){var t,n,r,e,o,i,s,l,u,a,c=this;i=this.get("collection"),n=function(t,n){return c.set({loaded:c.get("loaded")+t,total:c.get("total")+n}),void 0},o={},t=function(t){var r;return r=t.getProgress(),n(r.loaded,r.total),o[t.cid]=r},u=function(t){var r;return r=o[t.cid],n(-r.loaded,-r.total),delete o[t.cid]},e=function(t){var r,e;return e=o[t.cid],null!=e?(r=t.getProgress(),n(r.loaded-e.loaded,r.total-e.total),o[t.cid]=r):void 0},a=function(){var t;return o={},t={loaded:0,total:0},c.get("collection").each(function(n){var r;return r=n.getProgress(),o[n.cid]=r,t.loaded+=r.loaded,t.total+=r.total}),c.set(t)},l={add:t,remove:u,change:e,reset:a};for(s in l)r=l[s],this.listenTo(i,s,r);return a(),void 0},inBatch:function(t){this.stopListening(this.get("collection"));try{return t()}finally{this._updateAndStartListening()}}})}),r("MassUpload",["backbone","underscore","MassUpload/UploadCollection","MassUpload/FileLister","MassUpload/FileUploader","MassUpload/FileDeleter","MassUpload/State","MassUpload/UploadProgress"],function(t,n,r,e,o,i,s,l){return t.Model.extend({defaults:function(){return{status:"waiting",listFilesProgress:null,listFilesError:null,uploadProgress:null,uploadErrors:[]}},constructor:function(n){return this._removedUploads=[],t.Model.call(this,{},n)},initialize:function(t,n){var e,o=this;return this._options=n,this.uploads=null!=(e=null!=n?n.uploads:void 0)?e:new r,this.listenTo(this.uploads,"add-batch",this._onUploadBatchAdded),this.listenTo(this.uploads,"change:file change:error",function(t){return o._onUploadChanged(t)}),this.listenTo(this.uploads,"change:deleting",function(t){return o._onUploadDeleted(t)}),this.listenTo(this.uploads,"remove",function(t){return o._onUploadRemoved(t)}),this.listenTo(this.uploads,"reset",function(){return o._onUploadsReset()}),this.prepare()},prepare:function(){var t,n,r,s,u,a=this;return t=this._options,this.lister=null!=(r=null!=t?t.lister:void 0)?r:new e(t.doListFiles),this.lister.callbacks={onStart:function(){return a._onListerStart()},onProgress:function(t){return a._onListerProgress(t)},onSuccess:function(t){return a._onListerSuccess(t)},onError:function(t){return a._onListerError(t)},onStop:function(){return a._onListerStop()}},this.uploader=null!=(s=null!=t?t.uploader:void 0)?s:new o(t.doUploadFile),this.uploader.callbacks={onStart:function(t){return a._onUploaderStart(t)},onStop:function(t){return a._onUploaderStop(t)},onSuccess:function(t){return a._onUploaderSuccess(t)},onError:function(t,n){return a._onUploaderError(t,n)},onProgress:function(t,n){return a._onUploaderProgress(t,n)}},this.deleter=null!=(u=null!=t?t.deleter:void 0)?u:new i(t.doDeleteFile),this.deleter.callbacks={onStart:function(t){return a._onDeleterStart(t)},onSuccess:function(t){return a._onDeleterSuccess(t)},onError:function(t,n){return a._onDeleterError(t,n)},onStop:function(t){return a._onDeleterStop(t)}},this._uploadProgress=new l({collection:this.uploads}),n=function(){return a.set({uploadProgress:a._uploadProgress.pick("loaded","total")})},this.listenTo(this._uploadProgress,"change",n),n()},fetchFileInfosFromServer:function(){return this.lister.run()},retryListFiles:function(){return this.fetchFileInfosFromServer()},retryUpload:function(t){return t.set("error",null)},retryAllUploads:function(){return this.uploads.each(function(t){return t.set("error",null)})},addFiles:function(t){var n=this;return this._uploadProgress.inBatch(function(){return n.uploads.addFiles(t)})},removeUpload:function(t){return t.set("deleting",!0)},abort:function(){var t=this;return this.uploads.each(function(n){return t.removeUpload(n)}),this.uploads.reset(),this.prepare()},_onListerStart:function(){return this.set("status","listing-files"),this.set("listFilesError",null)},_onListerProgress:function(t){return this.set("listFilesProgress",t)},_onListerSuccess:function(t){return this.uploads.addFileInfos(t),this._tick()},_onListerError:function(t){return this.set("listFilesError",t),this.set("status","listing-files-error")},_onListerStop:function(){},_mergeUploadError:function(t,r,e){var o,i;return i=this.get("uploadErrors").slice(0),o=n.sortedIndex(i,{upload:t},function(t){return t.upload.id}),null==r?i.splice(o,0,{upload:t,error:e}):null==e?i.splice(o,1):i[o].error=e,this.set("uploadErrors",i)},_onUploadBatchAdded:function(t){var n,r,e,o;for(e=0,o=t.length;o>e;e++)r=t[e],n=r.get("error"),null!=n&&this._mergeUploadError(r,null,n);return this._forceBestTick()},_onUploadChanged:function(t){var n,r;return n=t.previous("error"),r=t.get("error"),n!==r&&this._mergeUploadError(t,n,r),this._forceBestTick()},_onUploadRemoved:function(){},_onUploadDeleted:function(t){return this._removedUploads.push(t),this._forceBestTick()},_onUploadsReset:function(){var t,n;return t=[],n={loaded:0,total:0},this.uploads.each(function(r){var e,o;return(e=r.get("error"))&&t.push({upload:r,error:e}),o=r.getProgress(),n.loaded+=o.loaded,n.total+=o.total}),this.set({uploadErrors:t,uploadProgress:n}),this._tick()},_onUploaderStart:function(t){var n;return n=this.uploads.get(t.name),n.set({uploading:!0,error:null})},_onUploaderStop:function(t){var n;return n=this.uploads.get(t.name),n.set("uploading",!1),this._tick()},_onUploaderProgress:function(t,n){var r;return r=this.uploads.get(t.name),r.updateWithProgress(n)},_onUploaderError:function(t,n){var r;return r=this.uploads.get(t.name),r.set("error",n)},_onUploaderSuccess:function(t){var n;return n=this.uploads.get(t.name),n.updateWithProgress({loaded:n.fstatSync().size,total:n.fstatSync().size})},_onDeleterStart:function(){return this.set("status","uploading")},_onDeleterSuccess:function(t){var n;return n=this.uploads.get(t.name),this.uploads.remove(n)},_onDeleterError:function(t,n){var r;return r=this.uploads.get(t.name),r.set("error",n)},_onDeleterStop:function(){return this._tick()},_tick:function(){var t,n,r;return r=this.uploads.next(),this._currentUpload=r,null!=r&&(r.get("deleting")?this.deleter.run(r.get("fileInfo")):this.uploader.run(r.get("file"))),n=this.get("uploadErrors").length?"uploading-error":null!=r?"uploading":(t=this.get("uploadProgress"),t.loaded===t.total?"waiting":"waiting-error"),this.set("status",n)},_forceBestTick:function(){var t;return t=this.uploads.next(),t!==this._currentUpload?this._currentUpload?this.uploader.abort():this._tick():void 0}})}),n(["./MassUpload"],function(t){return window.MassUpload=t}),r("index",function(){})}();