define("MassUpload/FileInfo",[],function(){var t;return t=function(){function t(t,n,o,e){this.name=t,this.lastModifiedDate=n,this.total=o,this.loaded=e}return t}(),t.fromJson=function(n){return new t(n.name,new Date(n.lastModifiedDate),n.total,n.loaded)},t.fromFile=function(n){return new t(n.name,n.lastModifiedDate,n.size,0)},t}),define("MassUpload/Upload",["backbone","./FileInfo"],function(t,n){return t.Model.extend({defaults:{file:null,fileInfo:null,error:null,uploading:!1,deleting:!1},initialize:function(t){var n,o,e;return n=null!=(e=t.file)?e:t.fileInfo,o=n.name,this.set({id:o})},updateWithProgress:function(t){var o;return o=n.fromFile(this.get("file")),o.loaded=t.loaded,o.total=t.total,this.set("fileInfo",o)},getProgress:function(){var t,n;return null==(n=this.get("fileInfo"))||this.hasConflict()?null!=(t=this.get("file"))?{loaded:0,total:t.size}:void 0:{loaded:n.loaded,total:n.total}},isFullyUploaded:function(){var t,n;return n=this.get("fileInfo"),t=this.get("error"),!this.get("uploading")&&!this.get("deleting")&&null==this.get("error")&&null!=n&&n.loaded===n.total},hasConflict:function(){var t,n;return n=this.get("fileInfo"),t=this.get("file"),null!=n&&null!=t&&(n.name!==t.name||n.lastModifiedDate.getTime()!==t.lastModifiedDate.getTime()||n.total!==t.size)}})}),define("MassUpload/UploadCollection",["backbone","./Upload"],function(t,n){return t.Collection.extend({model:n,addFiles:function(t){var o,e;return e=function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)o=t[e],i.push(new n({file:o}));return i}(),this._addWithMerge(e)},addFileInfos:function(t){var o,e;return e=function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)o=t[e],i.push(new n({fileInfo:o}));return i}(),this._addWithMerge(e)},next:function(){var t,n,o,e;return t=null,e=null,n=null,o=null,this.each(function(r){var i,s;return i=r.get("file"),s=r.get("fileInfo"),null==r.get("error")&&(r.get("deleting")&&(t||(t=r)),r.get("uploading")&&(e||(e=r)),i&&s&&s.loaded<s.total&&(n||(n=r)),i&&!s)?o||(o=r):void 0}),t||e||n||o},_addWithMerge:function(t){var n,o,e,r,i,s,l;for(r=[],s=0,l=t.length;l>s;s++)i=t[s],null!=(n=this.get(i.id))?(o=i.get("file"),e=i.get("fileInfo"),null!=o&&n.set({file:o}),null!=e&&n.set({fileInfo:e})):r.push(i);return this.add(r)}})}),define("MassUpload/FileLister",[],function(){var t;return t=function(){function t(t,n){this.doListFiles=t,this.callbacks=n,this.running=!1}return t.prototype.run=function(){var t,n=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(t=this.callbacks).onStart&&t.onStart(),this.doListFiles(function(t){var o;return"function"==typeof(o=n.callbacks).onProgress?o.onProgress(t):void 0},function(t){return n._onSuccess(t)},function(t){return n._onError(t)})},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop()},t.prototype._onError=function(t){return this.callbacks.onError(t),this._onStop()},t.prototype._onStop=function(){var t;return this.running=!1,"function"==typeof(t=this.callbacks).onStop?t.onStop():void 0},t}()}),define("MassUpload/FileUploader",["./FileInfo"],function(){var t;return t=function(){function t(t,n){this.doUpload=t,this.callbacks=n,this._file=null,this._abortCallback=null,this._aborting=!1}return t.prototype.run=function(t){var n,o=this;if(null!=this._file)throw"already running";return this._file=t,"function"==typeof(n=this.callbacks).onStart&&n.onStart(this._file),this._abortCallback=this.doUpload(t,function(n){return o._onProgress(t,n)},function(){return o._onSuccess(t)},function(n){return o._onError(t,n)})},t.prototype.abort=function(){return this._file&&!this._aborting&&(this._aborting=!0,"function"==typeof this._abortCallback)?this._abortCallback():void 0},t.prototype._onProgress=function(t,n){var o;return"function"==typeof(o=this.callbacks).onProgress?o.onProgress(t,n):void 0},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,n){var o;return"function"==typeof(o=this.callbacks).onError&&o.onError(t,n),this._onStop(t)},t.prototype._onStop=function(t){var n;return this._file=null,this._abortCallback=null,this._aborting=!1,"function"==typeof(n=this.callbacks).onStop?n.onStop(t):void 0},t}()}),define("MassUpload/FileDeleter",[],function(){var t;return t=function(){function t(t,n){this.doDeleteFile=t,this.callbacks=null!=n?n:{},this.running=!1}return t.prototype.run=function(t){var n,o=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(n=this.callbacks).onStart&&n.onStart(t),this.doDeleteFile(t,function(){return o._onSuccess(t)},function(n){return o._onError(t,n)})},t.prototype._onSuccess=function(t){var n;return"function"==typeof(n=this.callbacks).onSuccess&&n.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,n){var o;return"function"==typeof(o=this.callbacks).onError&&o.onError(t,n),this._onStop(t)},t.prototype._onStop=function(t){var n;return this.running=!1,"function"==typeof(n=this.callbacks).onStop&&n.onStop(t),void 0},t}()}),define("MassUpload/State",[],function(){var t;return t=function(){function t(t){var n,o,e,r;null==t&&(t={}),this.loaded=null!=(n=t.loaded)?n:0,this.total=null!=(o=t.total)?o:0,this.status=null!=(e=t.status)?e:"waiting",this.errors=null!=(r=t.errors)?r:[]}return t.prototype._extend=function(n){var o,e,r,i;return new t({loaded:null!=(o=n.loaded)?o:this.loaded,total:null!=(e=n.total)?e:this.total,status:null!=(r=n.status)?r:this.status,errors:null!=(i=n.errors)?i:this.errors})},t.prototype.isComplete=function(){return this.total&&this.loaded===this.total&&"waiting"===this.status&&!this.errors.length&&!0||!1},t.prototype.withTotal=function(t){return this._extend({total:t})},t.prototype.withLoaded=function(t){return this._extend({loaded:t})},t.prototype.withStatus=function(t){return this._extend({status:t})},t.prototype.withAnError=function(t){var n;return n=this.errors.slice(0),n.push(t),this._extend({errors:n})},t.prototype.withoutAnError=function(t){var n,o;return o=this.errors.slice(0),n=o.indexOf(t),o.splice(n,1),this._extend({errors:o})},t}()}),define("MassUpload/UploadProgress",["backbone"],function(t){return t.Model.extend({defaults:{loaded:0,total:0},initialize:function(){var t,n,o,e,r,i,s,l,u,a,d=this;if(i=this.get("collection"),null==i)throw"Must initialize UploadProgress with `collection`, an UploadCollection";n=function(t,n){return d.set({loaded:d.get("loaded")+t,total:d.get("total")+n}),void 0},r={},t=function(t){var o;return o=t.getProgress(),n(o.loaded,o.total),r[t.cid]=o},u=function(t){var o;return o=r[t.cid],n(-o.loaded,-o.total),delete r[t.cid]},e=function(t){var o,e;return e=r[t.cid],null!=e?(o=t.getProgress(),n(o.loaded-e.loaded,o.total-e.total),r[t.cid]=o):void 0},a=function(){var t;return r={},t={loaded:0,total:0},d.get("collection").each(function(n){var o;return o=n.getProgress(),r[n.cid]=o,t.loaded+=o.loaded,t.total+=o.total}),d.set(t)},l={add:t,remove:u,change:e,reset:a};for(s in l)o=l[s],this.listenTo(i,s,o);return a(),void 0}})}),define("MassUpload",["backbone","underscore","MassUpload/UploadCollection","MassUpload/FileLister","MassUpload/FileUploader","MassUpload/FileDeleter","MassUpload/State","MassUpload/UploadProgress"],function(t,n,o,e,r,i,s,l){return t.Model.extend({defaults:function(){return{status:"waiting",listFilesProgress:null,listFilesError:null,uploadProgress:null,uploadErrors:[]}},constructor:function(n){return this._removedUploads=[],t.Model.call(this,{},n)},initialize:function(t,n){var e,r=this;return this._options=n,this.uploads=null!=(e=null!=n?n.uploads:void 0)?e:new o,this.listenTo(this.uploads,"add change:file change:error",function(t){return r._onUploadAdded(t)}),this.listenTo(this.uploads,"change:deleting",function(t){return r._onUploadDeleted(t)}),this.listenTo(this.uploads,"remove",function(t){return r._onUploadRemoved(t)}),this.listenTo(this.uploads,"reset",function(){return r._onUploadsReset()}),this.prepare()},prepare:function(){var t,n,o,s,u,a,d=this;return t=this._options,this.lister=null!=(s=null!=t?t.lister:void 0)?s:new e(t.doListFiles),this.lister.callbacks={onStart:function(){return d._onListerStart()},onProgress:function(t){return d._onListerProgress(t)},onSuccess:function(t){return d._onListerSuccess(t)},onError:function(t){return d._onListerError(t)},onStop:function(){return d._onListerStop()}},this.uploader=null!=(u=null!=t?t.uploader:void 0)?u:new r(t.doUploadFile),this.uploader.callbacks={onStart:function(t){return d._onUploaderStart(t)},onStop:function(t){return d._onUploaderStop(t)},onSuccess:function(t){return d._onUploaderSuccess(t)},onError:function(t,n){return d._onUploaderError(t,n)},onProgress:function(t,n){return d._onUploaderProgress(t,n)}},this.deleter=null!=(a=null!=t?t.deleter:void 0)?a:new i(t.doDeleteFile),this.deleter.callbacks={onStart:function(t){return d._onDeleterStart(t)},onSuccess:function(t){return d._onDeleterSuccess(t)},onError:function(t,n){return d._onDeleterError(t,n)},onStop:function(t){return d._onDeleterStop(t)}},o=new l({collection:this.uploads}),n=function(){return d.set({uploadProgress:o.pick("loaded","total")})},this.listenTo(o,"change",n),n()},fetchFileInfosFromServer:function(){return this.lister.run()},retryListFiles:function(){return this.fetchFileInfosFromServer()},retryUpload:function(t){return t.set("error",null)},retryAllUploads:function(){return this.uploads.each(function(t){return t.set("error",null)})},addFiles:function(t){return this.uploads.addFiles(t)},removeUpload:function(t){return t.set("deleting",!0)},abort:function(){var t=this;return this.uploads.each(function(n){return t.removeUpload(n)}),this.uploads.reset(),this.prepare()},_onListerStart:function(){return this.set("status","listing-files"),this.set("listFilesError",null)},_onListerProgress:function(t){return this.set("listFilesProgress",t)},_onListerSuccess:function(t){return this.uploads.addFileInfos(t),this._tick()},_onListerError:function(t){return this.set("listFilesError",t),this.set("status","listing-files-error")},_onListerStop:function(){},_onUploadAdded:function(t){var o,e,r,i;return o=t.previous("error"),e=t.get("error"),o!==e&&(i=this.get("uploadErrors").slice(0),r=n.sortedIndex(i,{upload:t},function(t){return t.upload.id}),o?e?i[r].error=e:i.splice(r,1):i.splice(r,0,{upload:t,error:e}),this.set("uploadErrors",i)),this._forceBestTick()},_onUploadRemoved:function(){},_onUploadDeleted:function(t){return this._removedUploads.push(t),this._forceBestTick()},_onUploadsReset:function(){var t,n;return t=[],n={loaded:0,total:0},this.uploads.each(function(o){var e,r;return(e=o.get("error"))&&t.push({upload:o,error:e}),r=o.getProgress(),n.loaded+=r.loaded,n.total+=r.total}),this.set({uploadErrors:t,uploadProgress:n}),this._tick()},_onUploaderStart:function(t){var n;return n=this.uploads.get(t.name),n.set({uploading:!0,error:null})},_onUploaderStop:function(t){var n;return n=this.uploads.get(t.name),n.set("uploading",!1),this._tick()},_onUploaderProgress:function(t,n){var o;return o=this.uploads.get(t.name),o.updateWithProgress(n)},_onUploaderError:function(t,n){var o;return o=this.uploads.get(t.name),o.set("error",n)},_onUploaderSuccess:function(t){var n;return n=this.uploads.get(t.name),n.updateWithProgress({loaded:t.size,total:t.size})},_onDeleterStart:function(){return this.set("status","uploading")},_onDeleterSuccess:function(t){var n;return n=this.uploads.get(t.name),this.uploads.remove(n)},_onDeleterError:function(t,n){var o;return o=this.uploads.get(t.name),o.set("error",n)},_onDeleterStop:function(){return this._tick()},_tick:function(){var t,n,o;return o=this.uploads.next(),this._currentUpload=o,null!=o&&(o.get("deleting")?this.deleter.run(o.get("fileInfo")):this.uploader.run(o.get("file"))),n=this.get("uploadErrors").length?"uploading-error":null!=o?"uploading":(t=this.get("uploadProgress"),t.loaded===t.total?"waiting":"waiting-error"),this.set("status",n)},_forceBestTick:function(){var t;return t=this.uploads.next(),t!==this._currentUpload?this._currentUpload?this.uploader.abort():this._tick():void 0}})}),define("mass-upload",["MassUpload"],function(t){return t});