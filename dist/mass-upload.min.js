define("MassUpload/FileInfo",[],function(){var t;return t=function(){function t(t,r,e,n){this.name=t,this.lastModifiedDate=r,this.total=e,this.loaded=n}return t}(),t.fromJson=function(r){return new t(r.name,new Date(r.lastModifiedDate),r.total,r.loaded)},t.fromFile=function(r){return new t(r.name,r.lastModifiedDate,r.size,0)},t});var __hasProp={}.hasOwnProperty,__extends=function(t,r){function e(){this.constructor=t}for(var n in r)__hasProp.call(r,n)&&(t[n]=r[n]);return e.prototype=r.prototype,t.prototype=new e,t.__super__=r.prototype,t};define("MassUpload/Upload",["backbone","./FileInfo"],function(t,r){var e,n;return e=function(t){function e(){return n=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.defaults={file:null,fileInfo:null,error:null,uploading:!1,deleting:!1},e.prototype.initialize=function(t){var r,e,n;return r=null!=(n=t.file)?n:t.fileInfo,e=r.name,this.set({id:e})},e.prototype.updateWithProgress=function(t){var e,n;return n=this.fstatSync(),e=new r(this.id,n.lastModifiedDate,t.total,t.loaded),this.set("fileInfo",e)},e.prototype.getProgress=function(){var t,r;return null==(r=this.get("fileInfo"))||this.hasConflict()?null!=(t=this.get("file"))?{loaded:0,total:this.fstatSync().size}:void 0:{loaded:r.loaded,total:r.total}},e.prototype.fstatSync=function(){var t;return t=this.get("file"),null!=t?null!=this._fstat?this._fstat:this._fstat={size:t.size,lastModifiedDate:t.lastModifiedDate}:void 0},e.prototype.isFullyUploaded=function(){var t,r;return r=this.get("fileInfo"),t=this.get("error"),!this.get("uploading")&&!this.get("deleting")&&null==this.get("error")&&null!=r&&r.loaded===r.total},e.prototype.hasConflict=function(){var t,r;return r=this.get("fileInfo"),t=this.get("file"),null!=r&&null!=t&&(r.name!==t.name||r.lastModifiedDate.getTime()!==this.fstatSync().lastModifiedDate.getTime()||r.total!==this.fstatSync().size)},e}(t.Model)});var __hasProp={}.hasOwnProperty,__extends=function(t,r){function e(){this.constructor=t}for(var n in r)__hasProp.call(r,n)&&(t[n]=r[n]);return e.prototype=r.prototype,t.prototype=new e,t.__super__=r.prototype,t};define("MassUpload/UploadCollection",["backbone","./Upload"],function(t,r){var e,n,o;return n=function(){function t(){this._clear()}return t.prototype._clear=function(){return this.deleting=[],this.uploading=[],this.unfinished=[],this.unstarted=[]},t.prototype.uploadAttributesToState=function(t){var r;return r=null!=t.error?null:t.deleting?"deleting":t.uploading?"uploading":null!=t.file&&null!=t.fileInfo&&t.fileInfo.loaded<t.fileInfo.total?"unfinished":null!=t.file&&null==t.fileInfo?"unstarted":null},t.prototype.addBatch=function(t){var r,e,n,o,i;for(i=[],n=0,o=t.length;o>n;n++)e=t[n],r=this.uploadAttributesToState(e.attributes),null!=r?i.push(this[r].push(e)):i.push(void 0);return i},t.prototype._removeUploadFromArray=function(t,r){var e;return e=r.indexOf(t),e>=0?r.splice(e,1):void 0},t.prototype.remove=function(t){var r;return r=this.uploadAttributesToState(t.attributes),null!=r?this._removeUploadFromArray(t.attributes,this[r]):void 0},t.prototype.change=function(t){var r,e;return e=this.uploadAttributesToState(t.previousAttributes()),r=this.uploadAttributesToState(t.attributes),e!==r&&(null!=e&&this._removeUploadFromArray(t,this[e]),null!=r)?this[r].push(t):void 0},t.prototype.reset=function(t){return this._clear(),this.addBatch(t.models)},t.prototype.next=function(){var t,r,e,n;return null!=(t=null!=(r=null!=(e=null!=(n=this.deleting[0])?n:this.uploading[0])?e:this.unfinished[0])?r:this.unstarted[0])?t:null},t}(),e=function(t){function e(){return o=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.model=r,e.prototype.initialize=function(){var t,r,e,o;for(this._priorityQueue=new n,this.on("add-batch",this._priorityQueue.addBatch,this._priorityQueue),o=["change","remove","reset"],r=0,e=o.length;e>r;r++)t=o[r],this.on(t,this._priorityQueue[t],this._priorityQueue);return this._priorityQueue.reset(this)},e.prototype.addFiles=function(t){var e,n;return n=function(){var n,o,i;for(i=[],n=0,o=t.length;o>n;n++)e=t[n],i.push(new r({file:e}));return i}(),this._addWithMerge(n)},e.prototype.addFileInfos=function(t){var e,n;return n=function(){var n,o,i;for(i=[],n=0,o=t.length;o>n;n++)e=t[n],i.push(new r({fileInfo:e}));return i}(),this._addWithMerge(n)},e.prototype.next=function(){return this._priorityQueue.next()},e.prototype._addWithMerge=function(t){var r,e,n,o,i,s,l;for(o=[],s=0,l=t.length;l>s;s++)i=t[s],null!=(r=this.get(i.id))?(e=i.get("file"),n=i.get("fileInfo"),null!=e&&r.set({file:e}),null!=n&&r.set({fileInfo:n})):o.push(i);return o.length?(this.add(o),this.trigger("add-batch",o)):void 0},e}(t.Collection)}),define("MassUpload/FileLister",[],function(){var t;return t=function(){function t(t,r){this.doListFiles=t,this.callbacks=r,this.running=!1}return t.prototype.run=function(){var t,r=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(t=this.callbacks).onStart&&t.onStart(),this.doListFiles(function(t){var e;return"function"==typeof(e=r.callbacks).onProgress?e.onProgress(t):void 0},function(t){return r._onSuccess(t)},function(t){return r._onError(t)})},t.prototype._onSuccess=function(t){var r;return"function"==typeof(r=this.callbacks).onSuccess&&r.onSuccess(t),this._onStop()},t.prototype._onError=function(t){return this.callbacks.onError(t),this._onStop()},t.prototype._onStop=function(){var t;return this.running=!1,"function"==typeof(t=this.callbacks).onStop?t.onStop():void 0},t}()}),define("MassUpload/FileUploader",["./FileInfo"],function(){var t;return t=function(){function t(t,r){this.doUpload=t,this.callbacks=r,this._file=null,this._abortCallback=null,this._aborting=!1}return t.prototype.run=function(t){var r,e=this;if(null!=this._file)throw"already running";return this._file=t,"function"==typeof(r=this.callbacks).onStart&&r.onStart(this._file),this._abortCallback=this.doUpload(t,function(r){return e._onProgress(t,r)},function(){return e._onSuccess(t)},function(r){return e._onError(t,r)})},t.prototype.abort=function(){return this._file&&!this._aborting&&(this._aborting=!0,"function"==typeof this._abortCallback)?this._abortCallback():void 0},t.prototype._onProgress=function(t,r){var e;return"function"==typeof(e=this.callbacks).onProgress?e.onProgress(t,r):void 0},t.prototype._onSuccess=function(t){var r;return"function"==typeof(r=this.callbacks).onSuccess&&r.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,r){var e;return"function"==typeof(e=this.callbacks).onError&&e.onError(t,r),this._onStop(t)},t.prototype._onStop=function(t){var r;return this._file=null,this._abortCallback=null,this._aborting=!1,"function"==typeof(r=this.callbacks).onStop?r.onStop(t):void 0},t}()}),define("MassUpload/FileDeleter",[],function(){var t;return t=function(){function t(t,r){this.doDeleteFile=t,this.callbacks=null!=r?r:{},this.running=!1}return t.prototype.run=function(t){var r,e=this;if(this.running)throw"already running";return this.running=!0,"function"==typeof(r=this.callbacks).onStart&&r.onStart(t),this.doDeleteFile(t,function(){return e._onSuccess(t)},function(r){return e._onError(t,r)})},t.prototype._onSuccess=function(t){var r;return"function"==typeof(r=this.callbacks).onSuccess&&r.onSuccess(t),this._onStop(t)},t.prototype._onError=function(t,r){var e;return"function"==typeof(e=this.callbacks).onError&&e.onError(t,r),this._onStop(t)},t.prototype._onStop=function(t){var r;return this.running=!1,"function"==typeof(r=this.callbacks).onStop&&r.onStop(t),void 0},t}()}),define("MassUpload/State",[],function(){var t;return t=function(){function t(t){var r,e,n,o;null==t&&(t={}),this.loaded=null!=(r=t.loaded)?r:0,this.total=null!=(e=t.total)?e:0,this.status=null!=(n=t.status)?n:"waiting",this.errors=null!=(o=t.errors)?o:[]}return t.prototype._extend=function(r){var e,n,o,i;return new t({loaded:null!=(e=r.loaded)?e:this.loaded,total:null!=(n=r.total)?n:this.total,status:null!=(o=r.status)?o:this.status,errors:null!=(i=r.errors)?i:this.errors})},t.prototype.isComplete=function(){return this.total&&this.loaded===this.total&&"waiting"===this.status&&!this.errors.length&&!0||!1},t.prototype.withTotal=function(t){return this._extend({total:t})},t.prototype.withLoaded=function(t){return this._extend({loaded:t})},t.prototype.withStatus=function(t){return this._extend({status:t})},t.prototype.withAnError=function(t){var r;return r=this.errors.slice(0),r.push(t),this._extend({errors:r})},t.prototype.withoutAnError=function(t){var r,e;return e=this.errors.slice(0),r=e.indexOf(t),e.splice(r,1),this._extend({errors:e})},t}()}),define("MassUpload/UploadProgress",["backbone"],function(t){return t.Model.extend({defaults:{loaded:0,total:0},initialize:function(){var t;if(t=this.get("collection"),null==t)throw"Must initialize UploadProgress with `collection`, an UploadCollection";return this._updateAndStartListening()},_updateAndStartListening:function(){var t,r,e,n,o,i,s,l,u,a,d=this;i=this.get("collection"),r=function(t,r){return d.set({loaded:d.get("loaded")+t,total:d.get("total")+r}),void 0},o={},t=function(t){var e;return e=t.getProgress(),r(e.loaded,e.total),o[t.cid]=e},u=function(t){var e;return e=o[t.cid],r(-e.loaded,-e.total),delete o[t.cid]},n=function(t){var e,n;return n=o[t.cid],null!=n?(e=t.getProgress(),r(e.loaded-n.loaded,e.total-n.total),o[t.cid]=e):void 0},a=function(){var t;return o={},t={loaded:0,total:0},d.get("collection").each(function(r){var e;return e=r.getProgress(),o[r.cid]=e,t.loaded+=e.loaded,t.total+=e.total}),d.set(t)},l={add:t,remove:u,change:n,reset:a};for(s in l)e=l[s],this.listenTo(i,s,e);return a(),void 0},inBatch:function(t){this.stopListening(this.get("collection"));try{return t()}finally{this._updateAndStartListening()}}})}),define("MassUpload",["backbone","underscore","MassUpload/UploadCollection","MassUpload/FileLister","MassUpload/FileUploader","MassUpload/FileDeleter","MassUpload/State","MassUpload/UploadProgress"],function(t,r,e,n,o,i,s,l){return t.Model.extend({defaults:function(){return{status:"waiting",listFilesProgress:null,listFilesError:null,uploadProgress:null,uploadErrors:[]}},constructor:function(r){return this._removedUploads=[],t.Model.call(this,{},r)},initialize:function(t,r){var n,o=this;return this._options=r,this.uploads=null!=(n=null!=r?r.uploads:void 0)?n:new e,this.listenTo(this.uploads,"add-batch",this._onUploadBatchAdded),this.listenTo(this.uploads,"change:file change:error",function(t){return o._onUploadChanged(t)}),this.listenTo(this.uploads,"change:deleting",function(t){return o._onUploadDeleted(t)}),this.listenTo(this.uploads,"remove",function(t){return o._onUploadRemoved(t)}),this.listenTo(this.uploads,"reset",function(){return o._onUploadsReset()}),this.prepare()},prepare:function(){var t,r,e,s,u,a=this;return t=this._options,this.lister=null!=(e=null!=t?t.lister:void 0)?e:new n(t.doListFiles),this.lister.callbacks={onStart:function(){return a._onListerStart()},onProgress:function(t){return a._onListerProgress(t)},onSuccess:function(t){return a._onListerSuccess(t)},onError:function(t){return a._onListerError(t)},onStop:function(){return a._onListerStop()}},this.uploader=null!=(s=null!=t?t.uploader:void 0)?s:new o(t.doUploadFile),this.uploader.callbacks={onStart:function(t){return a._onUploaderStart(t)},onStop:function(t){return a._onUploaderStop(t)},onSuccess:function(t){return a._onUploaderSuccess(t)},onError:function(t,r){return a._onUploaderError(t,r)},onProgress:function(t,r){return a._onUploaderProgress(t,r)}},this.deleter=null!=(u=null!=t?t.deleter:void 0)?u:new i(t.doDeleteFile),this.deleter.callbacks={onStart:function(t){return a._onDeleterStart(t)},onSuccess:function(t){return a._onDeleterSuccess(t)},onError:function(t,r){return a._onDeleterError(t,r)},onStop:function(t){return a._onDeleterStop(t)}},this._uploadProgress=new l({collection:this.uploads}),r=function(){return a.set({uploadProgress:a._uploadProgress.pick("loaded","total")})},this.listenTo(this._uploadProgress,"change",r),r()},fetchFileInfosFromServer:function(){return this.lister.run()},retryListFiles:function(){return this.fetchFileInfosFromServer()},retryUpload:function(t){return t.set("error",null)},retryAllUploads:function(){return this.uploads.each(function(t){return t.set("error",null)})},addFiles:function(t){var r=this;return this._uploadProgress.inBatch(function(){return r.uploads.addFiles(t)})},removeUpload:function(t){return t.set("deleting",!0)},abort:function(){var t=this;return this.uploads.each(function(r){return t.removeUpload(r)}),this.uploads.reset(),this.prepare()},_onListerStart:function(){return this.set("status","listing-files"),this.set("listFilesError",null)},_onListerProgress:function(t){return this.set("listFilesProgress",t)},_onListerSuccess:function(t){return this.uploads.addFileInfos(t),this._tick()},_onListerError:function(t){return this.set("listFilesError",t),this.set("status","listing-files-error")},_onListerStop:function(){},_mergeUploadError:function(t,e,n){var o,i;return i=this.get("uploadErrors").slice(0),o=r.sortedIndex(i,{upload:t},function(t){return t.upload.id}),null==e?i.splice(o,0,{upload:t,error:n}):null==n?i.splice(o,1):i[o].error=n,this.set("uploadErrors",i)},_onUploadBatchAdded:function(t){var r,e,n,o;for(n=0,o=t.length;o>n;n++)e=t[n],r=e.get("error"),null!=r&&this._mergeUploadError(e,null,r);return this._forceBestTick()},_onUploadChanged:function(t){var r,e;return r=t.previous("error"),e=t.get("error"),r!==e&&this._mergeUploadError(t,r,e),this._forceBestTick()},_onUploadRemoved:function(){},_onUploadDeleted:function(t){return this._removedUploads.push(t),this._forceBestTick()},_onUploadsReset:function(){var t,r;return t=[],r={loaded:0,total:0},this.uploads.each(function(e){var n,o;return(n=e.get("error"))&&t.push({upload:e,error:n}),o=e.getProgress(),r.loaded+=o.loaded,r.total+=o.total}),this.set({uploadErrors:t,uploadProgress:r}),this._tick()},_onUploaderStart:function(t){var r;return r=this.uploads.get(t.name),r.set({uploading:!0,error:null})},_onUploaderStop:function(t){var r;return r=this.uploads.get(t.name),r.set("uploading",!1),this._tick()},_onUploaderProgress:function(t,r){var e;return e=this.uploads.get(t.name),e.updateWithProgress(r)},_onUploaderError:function(t,r){var e;return e=this.uploads.get(t.name),e.set("error",r)},_onUploaderSuccess:function(t){var r;return r=this.uploads.get(t.name),r.updateWithProgress({loaded:r.fstatSync().size,total:r.fstatSync().size})},_onDeleterStart:function(){return this.set("status","uploading")},_onDeleterSuccess:function(t){var r;return r=this.uploads.get(t.name),this.uploads.remove(r)},_onDeleterError:function(t,r){var e;return e=this.uploads.get(t.name),e.set("error",r)},_onDeleterStop:function(){return this._tick()},_tick:function(){var t,r,e;return e=this.uploads.next(),this._currentUpload=e,null!=e&&(e.get("deleting")?this.deleter.run(e.get("fileInfo")):this.uploader.run(e.get("file"))),r=this.get("uploadErrors").length?"uploading-error":null!=e?"uploading":(t=this.get("uploadProgress"),t.loaded===t.total?"waiting":"waiting-error"),this.set("status",r)},_forceBestTick:function(){var t;return t=this.uploads.next(),t!==this._currentUpload?this._currentUpload?this.uploader.abort():this._tick():void 0}})}),define("mass-upload",["MassUpload"],function(t){return t});